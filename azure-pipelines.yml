# =========================================
# Controlled Checkmarx SAST Pipeline
# Self-hosted agent: HarshAgent
# =========================================

# Disable PR-triggered pipelines completely
pr: none

# Trigger only on merge to main
trigger:
  branches:
    include:
      - main

# Optional scheduled scan
schedules:
- cron: "0 2 * * *"   # 02:00 UTC
  displayName: "Nightly Checkmarx SAST Scan"
  branches:
    include:
      - main
  always: true

# Use self-hosted agent
pool:
  name: Harsh
  agent: HarshAgent

steps:
- script: echo "Pipeline started on self-hosted agent"
  displayName: 'Pipeline init'

# -----------------------------------------
# Checkmarx SAST (SAST-only, gated execution)
# -----------------------------------------
- task: Application security testing@2025
  displayName: 'Checkmarx SAST Scan'
  condition: |
    and(
      succeeded(),
      or(
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        eq(variables['Build.Reason'], 'Schedule')
      )
    )
  inputs:
    projectName: 'HarshTest'

    # ---- REQUIRED TEAM ----
    fullTeamName: '/CxServer'

    enableProxy: false

    # -------- SAST ONLY --------
    enableSastScan: true
    enableDependencyScan: false

    CheckmarxService: 'CXSAST'
    enableSastBranching: false
    engineConfigId: '5'

    fullScansScheduled: false
    generatePDFReport: true
    avoidDuplicateScans: true
